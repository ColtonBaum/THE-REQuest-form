{% extends "admin/base.html" %}

{% block title %}All Requests{% endblock %}
{% block admin_content %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>All Requests</h3>
    <a href="{{ url_for('admin.export_csv') }}" class="btn btn-sm btn-outline-success">
      Export CSV
    </a>
  </div>

  <div class="table-responsive">
    <table id="requests-table"
           class="table table-striped table-bordered table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Name (ID)</th>
          <th>Job Name</th>
          <th>Job Number</th>
          <th>Submitted</th>
          <th>Items</th>
          <th>Status</th>
          <th>Assign Job</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in requests %}
        <tr>
          <td>{{ r.id }}</td>
          <td>{{ r.employee_name }} ({{ r.employee_id }})</td>

          <td>
            {% if r.job_id %}
              <a href="{{ url_for('admin.job_detail', job_id=r.job_id) }}">
                {{ r.job.name or r.job_name }}
              </a>
            {% else %}
              —
            {% endif %}
          </td>

          <td>{{ r.job.number if r.job_id else r.job_number or '—' }}</td>

          <td>{{ r.submitted_at.strftime('%Y-%m-%d %H:%M') }}</td>

          <td class="px-3">
            <ul class="mb-0 ps-3">
              {% for i in r.items %}
                <li>{{ i.quantity }}× {{ i.item_name }}</li>
              {% endfor %}
            </ul>
          </td>

          <td>
            <form method="post"
                  action="{{ url_for('admin.update_status', req_id=r.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <select name="status"
                      class="form-select form-select-sm
                             {% if r.status=='Not started' %}bg-danger text-white{% endif %}
                             {% if r.status=='In progress' %}bg-warning text-dark{% endif %}
                             {% if r.status=='Complete' %}bg-success text-white{% endif %}"
                      onchange="this.form.submit()">
                <option value="Not started" {% if r.status=='Not started' %}selected{% endif %}>Not started</option>
                <option value="In progress" {% if r.status=='In progress' %}selected{% endif %}>In progress</option>
                <option value="Complete" {% if r.status=='Complete' %}selected{% endif %}>Complete</option>
              </select>
            </form>
          </td>

          <td>
            <form method="post"
                  action="{{ url_for('admin.assign_request', req_id=r.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <select name="job_id"
                      class="form-select form-select-sm"
                      onchange="this.form.submit()">
                <option value="">— Unassigned —</option>
                {% for j in jobs %}
                <option value="{{ j.id }}" {% if r.job_id == j.id %}selected{% endif %}>
                  {{ j.name }} ({{ j.number }})
                </option>
                {% endfor %}
              </select>
            </form>
          </td>

          <td class="d-flex gap-2">
            <a href="{{ url_for('admin.edit_request', req_id=r.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
            <form method="post"
                  action="{{ url_for('admin.delete_request', req_id=r.id) }}"
                  onsubmit="return confirm('Are you sure you want to permanently delete this request?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Auto-refresh the page every 30 seconds -->
<script>
  setInterval(() => {
    window.location.reload();
  }, 30000); // 30 seconds
</script>
{% endblock %}
