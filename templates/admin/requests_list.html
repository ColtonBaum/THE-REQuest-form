{% extends "admin/base.html" %}
{% block title %}All Requests{% endblock %}

{% block admin_content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Requests</h3>
    <a href="{{ url_for('admin.export_csv') }}" class="btn btn-outline-success btn-sm">Export CSV</a>
  </div>

  <!-- Active Requests -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      Active Requests
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table id="active-requests-table" class="table table-striped table-bordered m-0">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Name (ID)</th>
              <th>Job Name</th>
              <th>Job Number</th>
              <th>Submitted</th>
              <th>Items</th>
              <th>Status</th>
              <th>Assign Job</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for r in requests if r.status != 'Complete' or not r.job_id %}
            <tr>
              <td>{{ r.id }}</td>
              <td>{{ r.employee_name }}</td>
              <td>{{ r.job.name if r.job else r.job_name }}</td>
              <td>{{ r.job.number if r.job else r.job_number }}</td>
              <td>{{ r.submitted_at.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>
                <ul class="mb-0 ps-3">
                  {% for i in r.items %}
                  <li>{{ i.quantity }}× {{ i.item_name }}</li>
                  {% endfor %}
                </ul>
              </td>
              <td>
                <form method="post" action="{{ url_for('admin.update_status', req_id=r.id) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="Not started" {% if r.status == 'Not started' %}selected{% endif %}>Not started</option>
                    <option value="In progress" {% if r.status == 'In progress' %}selected{% endif %}>In progress</option>
                    <option value="Complete" {% if r.status == 'Complete' %}selected{% endif %}>Complete</option>
                  </select>
                </form>
              </td>
              <td>
                <form method="post" action="{{ url_for('admin.assign_request', req_id=r.id) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <select name="job_id" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">— Unassigned —</option>
                    {% for j in jobs %}
                    <option value="{{ j.id }}" {% if r.job_id == j.id %}selected{% endif %}>
                      {{ j.name }} ({{ j.number }})
                    </option>
                    {% endfor %}
                  </select>
                </form>
              </td>
              <td class="text-nowrap">
                <a href="{{ url_for('admin.edit_request', req_id=r.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
                <form method="post" action="{{ url_for('admin.delete_request', req_id=r.id) }}" style="display:inline;" onsubmit="return confirm('Delete this request?');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Completed Requests -->
  <div class="card shadow-sm">
    <div class="card-header bg-success text-white">
      Completed Requests
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table id="completed-requests-table" class="table table-striped table-bordered m-0">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Job</th>
              <th>Number</th>
              <th>Submitted</th>
              <th>Items</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for r in requests if r.status == 'Complete' %}
            <tr>
              <td>{{ r.id }}</td>
              <td>{{ r.employee_name }}</td>
              <td>{{ r.job.name if r.job else r.job_name }}</td>
              <td>{{ r.job.number if r.job else r.job_number }}</td>
              <td>{{ r.submitted_at.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>
                <ul class="mb-0 ps-3">
                  {% for i in r.items %}
                  <li>{{ i.quantity }}× {{ i.item_name }}</li>
                  {% endfor %}
                </ul>
              </td>
              <td class="text-nowrap">
                <a href="{{ url_for('admin.edit_request', req_id=r.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
                <form method="post" action="{{ url_for('admin.delete_request', req_id=r.id) }}" style="display:inline;" onsubmit="return confirm('Delete this request?');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Auto-refresh script -->
<script>
  setInterval(() => {
    window.location.reload();
  }, 30000);
</script>

{% endblock %}
