{% extends "admin/base.html" %}

{% block title %}Edit Request #{{ req.id }}{% endblock %}

{% block admin_content %}
<div class="container py-4">
  <h3>Edit Request #{{ req.id }}</h3>

  <form method="post">
    {{ form.hidden_tag() }}

    <div class="mb-3">
      {{ form.employee_name.label(class="form-label") }}
      {{ form.employee_name(class="form-control", id="employee_name") }}
    </div>

    <div class="mb-3">
      {{ form.job_name.label(class="form-label") }}
      {{ form.job_name(class="form-control", id="job_name") }}
    </div>

    <div class="mb-3">
      {{ form.job_number.label(class="form-label") }}
      {{ form.job_number(class="form-control", id="job_number") }}
    </div>

    <div class="mb-3">
      <label for="job_id" class="form-label">Reassign to Job</label>
      <select name="job_id" id="job_id" class="form-select">
        <option value="">â€”</option>
        {% for job in jobs %}
          <option value="{{ job.id }}"
            {% if job.id == req.job_id %}selected{% endif %}>
            {{ job.name }} ({{ job.number }})
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3" id="items-container">
      {{ form.items.label(class="form-label") }}
      {% for subform in form.items %}
      <div class="d-flex mb-2 item-row">
        {{ subform.item_name(class="form-control me-2") }}
        {{ subform.quantity(class="form-control me-2") }}
        <button type="button" class="btn btn-outline-danger remove-item">&times;</button>
      </div>
      {% endfor %}

      <!-- Hidden template for new items -->
      <div id="item-template" class="d-flex mb-2 item-row" style="display: none;">
        {{ form.items.empty_form.item_name(class="form-control me-2") }}
        {{ form.items.empty_form.quantity(class="form-control me-2") }}
        <button type="button" class="btn btn-outline-danger remove-item">&times;</button>
      </div>
    </div>

    <button type="button" id="add-item-btn" class="btn btn-outline-primary mb-3">
      + Add Item
    </button>

    <div class="mt-4">
      {{ form.submit(class="btn btn-primary") }}
      <a href="{{ url_for('admin.list_requests') }}" class="btn btn-secondary">Cancel</a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var container = document.getElementById('items-container');
    var template  = document.getElementById('item-template');

    document.getElementById('add-item-btn').addEventListener('click', function() {
      var clone = template.cloneNode(true);
      clone.style.display = 'flex';
      clone.id = '';

      // the WTForms subform fields inside the clone
      var nameInput = clone.querySelector('input[name$="-item_name"]');
      var qtyInput  = clone.querySelector('input[name$="-quantity"]');

      // reset values
      nameInput.value = '';
      qtyInput.value  = '';

      // rename so Flask will collect it as "new_item_name" / "new_item_qty"
      nameInput.name = 'new_item_name';
      qtyInput.name  = 'new_item_qty';

      container.appendChild(clone);
    });

    container.addEventListener('click', function(e) {
      if (e.target.classList.contains('remove-item')) {
        var row = e.target.closest('.item-row');
        row.remove();
      }
    });
  });
</script>
{% endblock %}
