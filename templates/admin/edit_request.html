{% extends "admin/base.html" %}

{% block title %}Edit Request #{{ req.id }}{% endblock %}

{% block admin_content %}
<div class="container py-4">
  <h3>Edit Request #{{ req.id }}</h3>
  <form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="mb-3">
      <label for="employee_name" class="form-label">Employee Name</label>
      <input type="text" id="employee_name" name="employee_name" class="form-control" value="{{ req.employee_name }}" required>
    </div>

    <div class="mb-3">
      <label for="job_name" class="form-label">Job Name</label>
      <input type="text" id="job_name" name="job_name" class="form-control" value="{{ req.job_name }}" required>
    </div>

    <div class="mb-3">
      <label for="job_number" class="form-label">Job Number</label>
      <input type="text" id="job_number" name="job_number" class="form-control" value="{{ req.job_number }}" required>
    </div>

    <div class="mb-3" id="items-container">
      <label class="form-label">Items</label>
      {% for i in req.items %}
      <div class="d-flex mb-2 item-row">
        <input type="text" name="item_name_{{ i.id }}" class="form-control me-2" value="{{ i.item_name }}" placeholder="Item name" required>
        <input type="number" name="item_qty_{{ i.id }}" class="form-control me-2" value="{{ i.quantity }}" placeholder="Qty" min="0" required>
        <button type="button" class="btn btn-outline-danger remove-item">&times;</button>
      </div>
      {% endfor %}
      <!-- Hidden template for new items -->
      <div id="item-template" class="d-flex mb-2 item-row" style="display: none;">
        <input type="text" name="item_name__" class="form-control me-2" placeholder="Item name" required>
        <input type="number" name="item_qty__" class="form-control me-2" placeholder="Qty" min="0" required>
        <button type="button" class="btn btn-outline-danger remove-item">&times;</button>
      </div>
    </div>

    <button type="button" id="add-item-btn" class="btn btn-outline-primary mb-3">+ Add Item</button>

    <div class="mt-4">
      <button type="submit" class="btn btn-primary">Save Changes</button>
      <a href="{{ url_for('admin.list_requests') }}" class="btn btn-secondary">Cancel</a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('items-container');
    const template = document.getElementById('item-template');
    let newIndex = 0;

    document.getElementById('add-item-btn').addEventListener('click', function() {
      newIndex += 1;
      const clone = template.cloneNode(true);
      clone.style.display = 'flex';
      clone.id = '';
      // update name attributes
      const nameInput = clone.querySelector('input[type="text"]');
      const qtyInput = clone.querySelector('input[type="number"]');
      nameInput.name = `item_name_new_${newIndex}`;
      qtyInput.name = `item_qty_new_${newIndex}`;
      container.appendChild(clone);
    });

    container.addEventListener('click', function(e) {
      if (e.target.classList.contains('remove-item')) {
        const row = e.target.closest('.item-row');
        row.remove();
      }
    });
  });
</script>
{% endblock %}